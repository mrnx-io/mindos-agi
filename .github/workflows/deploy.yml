# =============================================================================
# MindOS - CI/CD Pipeline
# Build, test, and deploy to Fly.io + Restate Cloud
# =============================================================================

name: Deploy MindOS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      service:
        description: 'Deploy specific service (or "all")'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - mind-service
          - toolmesh
          - executor
          - grounding-service
          - drift-monitor
          - swarm-coordinator

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  RESTATE_CLOUD_API_KEY: ${{ secrets.RESTATE_CLOUD_API_KEY }}

jobs:
  # ---------------------------------------------------------------------------
  # Build & Test
  # ---------------------------------------------------------------------------
  build:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.5'

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Compile brand system
        run: |
          python3 packages/brand-system/bin/compile-system.py
          git diff --exit-code packages/brand-system

      - name: Type check
        run: bun run check

      - name: Lint
        run: bun run lint

      - name: Run tests
        run: bun run test
        continue-on-error: true  # Don't fail deploy on test failures initially

      - name: Build all packages
        run: bun run build

  # ---------------------------------------------------------------------------
  # Deploy Services to Fly.io
  # ---------------------------------------------------------------------------
  deploy-mind-service:
    name: Deploy mind-service
    needs: build
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.service == 'all' || github.event.inputs.service == 'mind-service'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@1.5

      - name: Deploy to Fly.io
        working-directory: apps/mind-service
        run: flyctl deploy --remote-only

      - name: Register with Restate Cloud
        if: env.RESTATE_CLOUD_API_KEY != ''
        run: |
          curl -X POST \
            -H "Authorization: Bearer $RESTATE_CLOUD_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"uri": "https://mindos-mind-service.fly.dev"}' \
            "${{ secrets.RESTATE_ADMIN_URL }}/deployments"

  deploy-toolmesh:
    name: Deploy toolmesh
    needs: build
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.service == 'all' || github.event.inputs.service == 'toolmesh'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@1.5

      - name: Deploy to Fly.io
        working-directory: apps/toolmesh
        run: flyctl deploy --remote-only

  deploy-executor:
    name: Deploy executor
    needs: build
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.service == 'all' || github.event.inputs.service == 'executor'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@1.5

      - name: Deploy to Fly.io
        working-directory: apps/executor
        run: flyctl deploy --remote-only

  deploy-grounding-service:
    name: Deploy grounding-service
    needs: build
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.service == 'all' || github.event.inputs.service == 'grounding-service'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@1.5

      - name: Deploy to Fly.io
        working-directory: apps/grounding-service
        run: flyctl deploy --remote-only

  deploy-drift-monitor:
    name: Deploy drift-monitor
    needs: build
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.service == 'all' || github.event.inputs.service == 'drift-monitor'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@1.5

      - name: Deploy to Fly.io
        working-directory: apps/drift-monitor
        run: flyctl deploy --remote-only

  deploy-swarm-coordinator:
    name: Deploy swarm-coordinator
    needs: build
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.service == 'all' || github.event.inputs.service == 'swarm-coordinator'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@1.5

      - name: Deploy to Fly.io
        working-directory: apps/swarm-coordinator
        run: flyctl deploy --remote-only

  # ---------------------------------------------------------------------------
  # Database Migrations
  # ---------------------------------------------------------------------------
  migrate:
    name: Run Database Migrations
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_DIRECT }}
        run: |
          # Install psql
          sudo apt-get update && sudo apt-get install -y postgresql-client

          # Run all migrations in order
          for migration in db/migrations/*.sql; do
            echo "Running migration: $migration"
            psql "$DATABASE_URL" -f "$migration"
          done

  # ---------------------------------------------------------------------------
  # Post-Deploy Health Checks
  # ---------------------------------------------------------------------------
  health-check:
    name: Health Checks
    needs: [deploy-mind-service, deploy-toolmesh, deploy-executor, deploy-grounding-service, deploy-drift-monitor, deploy-swarm-coordinator]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Check mind-service health
        run: |
          for i in {1..5}; do
            if curl -sf https://mindos-mind-service.fly.dev/restate/health; then
              echo "mind-service is healthy"
              exit 0
            fi
            sleep 10
          done
          echo "mind-service health check failed"
          exit 1

      - name: Check toolmesh health
        run: |
          for i in {1..5}; do
            if curl -sf https://mindos-toolmesh.fly.dev/health; then
              echo "toolmesh is healthy"
              exit 0
            fi
            sleep 10
          done
          echo "toolmesh health check failed"
          exit 1

      - name: Check executor health
        run: |
          for i in {1..5}; do
            if curl -sf https://mindos-executor.fly.dev/health; then
              echo "executor is healthy"
              exit 0
            fi
            sleep 10
          done
          echo "executor health check failed"
          exit 1

      - name: Check grounding-service health
        run: |
          for i in {1..5}; do
            if curl -sf https://mindos-grounding-service.fly.dev/health; then
              echo "grounding-service is healthy"
              exit 0
            fi
            sleep 10
          done
          echo "grounding-service health check failed"
          exit 1

      - name: Check drift-monitor health
        run: |
          for i in {1..5}; do
            if curl -sf https://mindos-drift-monitor.fly.dev/health; then
              echo "drift-monitor is healthy"
              exit 0
            fi
            sleep 10
          done
          echo "drift-monitor health check failed"
          exit 1

      - name: Check swarm-coordinator health
        run: |
          for i in {1..5}; do
            if curl -sf https://mindos-swarm-coordinator.fly.dev/health; then
              echo "swarm-coordinator is healthy"
              exit 0
            fi
            sleep 10
          done
          echo "swarm-coordinator health check failed"
          exit 1

  # ---------------------------------------------------------------------------
  # Notify on Failure
  # ---------------------------------------------------------------------------
  notify-failure:
    name: Notify on Failure
    needs: [build, deploy-mind-service, deploy-toolmesh, deploy-executor, deploy-grounding-service, deploy-drift-monitor, deploy-swarm-coordinator, health-check]
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Create failure summary
        run: |
          echo "## :x: Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
